# =============================================================================
# CELL 5: Define Password Protection Functions (IMPROVED)
# =============================================================================
print("\nCELL 5: Defining Password Protection Functions")
print("=" * 50)

def password_protect_with_msoffcrypto(file_path, password):
    """
    Password protect Excel file using msoffcrypto - most reliable method.
    Works cross-platform (Windows, Mac, Linux).
    """
    try:
        import msoffcrypto
        from openpyxl import load_workbook
        import io
        
        print(f"  Encrypting file with msoffcrypto...")
        
        # Step 1: Read the unencrypted file
        with open(file_path, 'rb') as f:
            file_content = f.read()
        
        # Step 2: Create encrypted version in memory
        encrypted_buffer = io.BytesIO()
        
        # Create office file object
        office_file = msoffcrypto.OfficeFile(io.BytesIO(file_content))
        
        # Set the password
        office_file.encrypt(password)
        
        # Save encrypted version
        office_file.save(encrypted_buffer)
        
        # Step 3: Write encrypted content back to file
        encrypted_buffer.seek(0)
        with open(file_path, 'wb') as f:
            f.write(encrypted_buffer.read())
        
        print(f"  ✓ File successfully encrypted with password")
        return True
        
    except Exception as e:
        print(f"  ✗ msoffcrypto encryption failed: {e}")
        return False

def password_protect_with_win32com(file_path, password):
    """
    Password protect using Excel COM automation (Windows only).
    Requires Excel to be installed.
    """
    if os.name != 'nt':
        print("  ⚠ Win32com only works on Windows")
        return False
        
    try:
        import win32com.client
        import pythoncom
        
        print(f"  Using Excel COM to encrypt file...")
        
        # Initialize COM
        pythoncom.CoInitialize()
        
        try:
            # Create Excel instance
            excel = win32com.client.Dispatch("Excel.Application")
            excel.Visible = False
            excel.DisplayAlerts = False
            
            # Open the workbook
            abs_path = os.path.abspath(file_path)
            workbook = excel.Workbooks.Open(abs_path)
            
            # Save with password (51 = xlOpenXMLWorkbook)
            workbook.SaveAs2(
                Filename=abs_path,
                FileFormat=51,
                Password=password
            )
            
            # Close everything
            workbook.Close(SaveChanges=False)
            excel.Quit()
            
            print(f"  ✓ File encrypted using Excel COM")
            return True
            
        finally:
            pythoncom.CoUninitialize()
            
    except ImportError:
        print(f"  ⚠ pywin32 not installed")
        return False
    except Exception as e:
        print(f"  ✗ Excel COM encryption failed: {e}")
        return False

def apply_password_protection(file_path, password):
    """
    Main function to apply password protection using best available method.
    """
    print(f"\nApplying password protection to: {os.path.basename(file_path)}")
    
    # Create backup before attempting encryption
    backup_path = file_path + ".backup_preencrypt"
    try:
        shutil.copy2(file_path, backup_path)
        print(f"  Created safety backup: {backup_path}")
    except Exception as e:
        print(f"  ⚠ Could not create backup: {e}")
        backup_path = None
    
    # Method 1: Try msoffcrypto first (most reliable)
    success = password_protect_with_msoffcrypto(file_path, password)
    
    # Method 2: If failed and on Windows, try Excel COM
    if not success and os.name == 'nt':
        print("  Trying alternative method (Excel COM)...")
        success = password_protect_with_win32com(file_path, password)
    
    # Verify the encryption worked
    if success:
        try:
            # Try to open the file with wrong password (should fail)
            test_wb = open_excel_workbook(file_path, "wrong_password_test")
            test_wb.close()
            # If we got here, encryption might have failed
            print("  ⚠ Warning: File may not be properly encrypted")
        except:
            # This is expected - file should not open with wrong password
            print("  ✓ Encryption verified - file requires password")
            
        # Remove backup if successful
        if backup_path and os.path.exists(backup_path):
            os.remove(backup_path)
            print("  Removed backup file")
    else:
        # Restore from backup if failed
        if backup_path and os.path.exists(backup_path):
            shutil.move(backup_path, file_path)
            print("  ⚠ Restored original file from backup")
    
    return success

# Set the main password function
password_protect_function = apply_password_protection

print("✓ Password protection functions defined")




# =============================================================================
# CELL 13: Apply Password Protection (IMPROVED)
# =============================================================================
print("\nCELL 13: Applying Password Protection")
print("=" * 50)

password_applied = False

# Check prerequisites
if not excel_processed:
    print("⚠ Skipping: Excel file was not processed successfully")
elif not REAPPLY_PASSWORD:
    print("⚠ Skipping: Password protection is disabled (REAPPLY_PASSWORD = False)")
elif not OUTPUT_PASSWORD or OUTPUT_PASSWORD == "your_password_here":
    print("⚠ Skipping: No password configured")
    print("  Set OUTPUT_PASSWORD in configuration to enable password protection")
else:
    # All prerequisites met - apply password protection
    print(f"Password protecting output file...")
    print(f"  File: {OUTPUT_EXCEL_PATH}")
    print(f"  File size: {os.path.getsize(OUTPUT_EXCEL_PATH):,} bytes")
    print(f"  Password length: {len(OUTPUT_PASSWORD)} characters")
    
    # Apply password protection
    password_applied = password_protect_function(OUTPUT_EXCEL_PATH, OUTPUT_PASSWORD)
    
    if password_applied:
        print("\n" + "="*50)
        print("✅ SUCCESS: Password protection applied!")
        print("="*50)
        print(f"  Protected file: {OUTPUT_EXCEL_PATH}")
        print(f"  Final size: {os.path.getsize(OUTPUT_EXCEL_PATH):,} bytes")
        print("\n  The file now requires a password to open.")
        print(f"  Password: {'*' * len(OUTPUT_PASSWORD)}")
    else:
        print("\n" + "="*50)
        print("⚠ PASSWORD PROTECTION FAILED")
        print("="*50)
        print("\nTroubleshooting steps:")
        print("1. Install msoffcrypto-tool:")
        print("   pip install --upgrade msoffcrypto-tool")
        print("\n2. For Windows users, install pywin32:")
        print("   pip install pywin32")
        print("\n3. Manual protection in Excel:")
        print("   - Open the file in Microsoft Excel")
        print("   - Go to File → Info → Protect Workbook")
        print("   - Select 'Encrypt with Password'")
        print("   - Enter your password and save")

# Final status summary
print("\n" + "="*50)
print("Password Protection Summary:")
if password_applied:
    print("  Status: ✓ PROTECTED")
    print("  Method: Encrypted with password")
    print("  Required to open: Yes")
else:
    print("  Status: ✗ NOT PROTECTED")
    print("  Method: None")
    print("  Required to open: No")
print("="*50)

# =============================================================================
# Alternative CELL 13: Failsafe Password Protection
# =============================================================================
print("\nCELL 13: Applying Password Protection (Failsafe Method)")
print("=" * 50)

def create_password_protected_copy(source_file, password):
    """
    Create a password-protected copy of the Excel file.
    """
    try:
        import subprocess
        import platform
        
        # Create output filename
        base_name = os.path.splitext(source_file)[0]
        protected_file = f"{base_name}_protected.xlsx"
        
        if platform.system() == "Windows":
            # Use PowerShell on Windows
            ps_script = f'''
            $excel = New-Object -ComObject Excel.Application
            $excel.Visible = $false
            $workbook = $excel.Workbooks.Open("{os.path.abspath(source_file)}")
            $workbook.SaveAs("{os.path.abspath(protected_file)}", 51, "{password}")
            $workbook.Close()
            $excel.Quit()
            '''
            
            result = subprocess.run(
                ["powershell", "-Command", ps_script],
                capture_output=True,
                text=True
            )
            
            if result.returncode == 0 and os.path.exists(protected_file):
                print(f"  ✓ Created protected copy: {protected_file}")
                return protected_file
        
        # If PowerShell fails or not on Windows, use Python
        import msoffcrypto
        from openpyxl import load_workbook
        
        # Load the workbook
        wb = load_workbook(source_file)
        wb.save(protected_file)
        wb.close()
        
        # Encrypt the new file
        with open(protected_file, 'rb') as f_in:
            file_content = f_in.read()
        
        office_file = msoffcrypto.OfficeFile(io.BytesIO(file_content))
        
        with open(protected_file, 'wb') as f_out:
            office_file.encrypt(password)
            office_file.save(f_out)
        
        print(f"  ✓ Created protected copy: {protected_file}")
        return protected_file
        
    except Exception as e:
        print(f"  ✗ Failed to create protected copy: {e}")
        return None

# Apply password protection
if excel_processed and REAPPLY_PASSWORD and OUTPUT_PASSWORD != "your_password_here":
    protected_path = create_password_protected_copy(OUTPUT_EXCEL_PATH, OUTPUT_PASSWORD)
    
    if protected_path:
        print(f"\n✅ Password-protected file created:")
        print(f"  Original: {OUTPUT_EXCEL_PATH}")
        print(f"  Protected: {protected_path}")
        print("\n  Use the protected version for distribution.")
    else:
        print("\n⚠ Could not create password-protected version")
        print("  Please protect the file manually in Excel")
