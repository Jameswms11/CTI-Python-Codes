# =============================================================================
# CELL 5: Define Password Protection Functions - WORKING VERSION
# =============================================================================
print("\nCELL 5: Defining Password Protection Functions")
print("=" * 50)

import io
import os
import shutil

def encrypt_excel_file(file_path, password="CTIIOCS"):
    """
    Encrypt an Excel file with a password using msoffcrypto.
    This is the most reliable cross-platform method.
    """
    try:
        import msoffcrypto
        import tempfile
        
        print(f"  Encrypting file: {os.path.basename(file_path)}")
        print(f"  Using password: {'*' * len(password)}")
        
        # Create a temporary file for the encrypted version
        temp_fd, temp_path = tempfile.mkstemp(suffix='.xlsx')
        os.close(temp_fd)
        
        try:
            # Open the unencrypted file
            with open(file_path, 'rb') as f_input:
                # Create an OfficeFile object
                ms_file = msoffcrypto.OfficeFile(f_input)
                
                # Encrypt and save to temp file
                with open(temp_path, 'wb') as f_output:
                    ms_file.encrypt(password, f_output)
            
            # Replace original with encrypted version
            shutil.move(temp_path, file_path)
            
            print(f"  ✓ File successfully encrypted")
            return True
            
        except Exception as e:
            # Clean up temp file if it exists
            if os.path.exists(temp_path):
                os.remove(temp_path)
            raise e
            
    except ImportError:
        print("  ✗ msoffcrypto not installed. Installing...")
        import subprocess
        subprocess.run(["pip", "install", "msoffcrypto-tool"], check=True)
        # Try again after installation
        return encrypt_excel_file(file_path, password)
    except Exception as e:
        print(f"  ✗ Encryption failed: {str(e)}")
        return False

# Set the password protection function
password_protect_function = lambda file_path, pwd: encrypt_excel_file(file_path, pwd)


# =============================================================================
# CELL 13: Apply Password Protection to compiled_iocs.xlsx
# =============================================================================
print("\nCELL 13: Applying Password Protection")
print("=" * 50)

# The password for the compiled_iocs file
FINAL_PASSWORD = "CTIIOCS"

password_applied = False

if excel_processed and os.path.exists(OUTPUT_EXCEL_PATH):
    print(f"Encrypting compiled_iocs.xlsx with password...")
    print(f"  File: {OUTPUT_EXCEL_PATH}")
    print(f"  Original size: {os.path.getsize(OUTPUT_EXCEL_PATH):,} bytes")
    
    # Create a backup first
    backup_path = OUTPUT_EXCEL_PATH + ".backup"
    shutil.copy2(OUTPUT_EXCEL_PATH, backup_path)
    print(f"  Created backup: {backup_path}")
    
    # Apply password encryption
    password_applied = encrypt_excel_file(OUTPUT_EXCEL_PATH, FINAL_PASSWORD)
    
    if password_applied:
        final_size = os.path.getsize(OUTPUT_EXCEL_PATH)
        print(f"  Final size: {final_size:,} bytes")
        
        # Remove backup if successful
        if os.path.exists(backup_path):
            os.remove(backup_path)
            print("  Removed backup file")
        
        print("\n" + "="*50)
        print("✅ SUCCESS: File encrypted with password 'CTIIOCS'")
        print("="*50)
        print(f"  Protected file: {OUTPUT_EXCEL_PATH}")
        print("  The file now requires password 'CTIIOCS' to open")
    else:
        # Restore from backup if failed
        if os.path.exists(backup_path):
            shutil.move(backup_path, OUTPUT_EXCEL_PATH)
            print("  Restored original file from backup")
        
        print("\n⚠ Password protection failed")
        print("  The file is NOT encrypted")
else:
    print("⚠ Cannot apply password - file not found or not processed")
    if not excel_processed:
        print("  Excel processing did not complete successfully")
    if not os.path.exists(OUTPUT_EXCEL_PATH):
        print(f"  Output file does not exist: {OUTPUT_EXCEL_PATH}")

print("="*50)

print("✓ Password protection function defined")
